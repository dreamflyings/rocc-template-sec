//see LICENSE for license
// The following is a RISC-V program to test the functionality of the
// aes RoCC accelerator.
// Compile with riscv-unknown-elf-gcc aes-rocc.c
// Run with spike --extension=aes pk a.out

#include <assert.h>
#include <stdio.h>
#include <stdint.h>
#include "aes.h"

int main() {
    //DO NOT MODIFY
    uchar enc_buf[128];
    uchar plaintext[32] = {0x6b,0xc1,0xbe,0xe2,0x2e,0x40,0x9f,0x96,0xe9,0x3d,0x7e,0x11,0x73,0x93,0x17,0x2a,0xae,0x2d,0x8a,0x57,0x1e,0x03,0xac,0x9c,0x9e,0xb7,0x6f,0xac,0x45,0xaf,0x8e,0x51};
    uchar ciphertext[32] = {0x60,0x1e,0xc3,0x13,0x77,0x57,0x89,0xa5,0xb7,0xa7,0xf5,0x04,0xbb,0xf3,0xd2,0x28,0xf4,0x43,0xe3,0xca,0x4d,0x62,0xb5,0x9a,0xca,0x84,0xe9,0x90,0xca,0xca,0xf5,0xc5};
    uchar iv[16] =  {0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0xfb,0xfc,0xfd,0xfe,0xff};
    uchar key[32] = {0x60,0x3d,0xeb,0x10,0x15,0xca,0x71,0xbe,0x2b,0x73,0xae,0xf0,0x85,0x7d,0x77,0x81,0x1f,0x35,0x2c,0x07,0x3b,0x61,0x08,0xd7,0x2d,0x98,0x10,0xa3,0x09,0x14,0xdf,0xf4};

    uchar decrypted_text[32];
    //END DO NOT MODIFY
    int dummy_result;
    uchar iv2[] = {0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0xfb,0xfc,0xfd,0xfe,0xff};
    unsigned long long initCycle, duration;
    initCycle = rdcycle();
    asm volatile ("fence"); //NOTE: fences are only needed if the accelerator is accessing memory
    //YOUR CODE HERE: Invoke your AES acclerator, write the encrypted output of plaintext to enc_buf
    // encrypt(key[0], plaintext[0], iv[0], enc_buf);
    aes_encrypt(256, key, iv, plaintext, enc_buf, 32, FALSE);
    
/*    int i = 0;
    while(enc_buf[i] != '\0')
    {
        printf("%x ", enc_buf[i] & 0xFF);
        i+=1;
    }*/
    asm volatile ("fence");

    //DO NOT MODIFY
    duration = rdcycle() - initCycle;
    printf("AES Encryption took %llu cycles!\n", duration);
    initCycle = rdcycle();
    //END DO NOT MODIFY

    //YOUR CODE HERE: Invoke your AES acclerator, write the decrypted output of enc_buf to decrypted_text
    aes_encrypt(256, key, iv2, ciphertext, decrypted_text, 32, TRUE);
    asm volatile ("fence");
    //DO NOT MODIFY
    duration = rdcycle() - initCycle;
    printf("AES Decryption took %llu cycles!\n", duration);

    // Check result
    assert(memcmp(enc_buf, ciphertext, 32) == 0);
    assert(memcmp(decrypted_text, plaintext, 32) == 0);
    //END DO NOT MODIFY
    return 0;
}
/*
uchar key[32] = {   0x60,0x3d,0xeb,0x10,0x15,0xca,0x71,0xbe,
                        0x2b,0x73,0xae,0xf0,0x85,0x7d,0x77,0x81,
                        0x1f,0x35,0x2c,0x07,0x3b,0x61,0x08,0xd7,
                        0x2d,0x98,0x10,0xa3,0x09,0x14,0xdf,0xf4};
    
    uchar iv[16] = {0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0xfb,0xfc,0xfd,0xfe,0xff};
    uchar iv2[16] = {0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0xfb,0xfc,0xfd,0xfe,0xff};
    
    uchar in[32] = {    0x6b,0xc1,0xbe,0xe2,0x2e,0x40,0x9f,0x96,
                        0xe9,0x3d,0x7e,0x11,0x73,0x93,0x17,0x2a,
                        0xae,0x2d,0x8a,0x57,0x1e,0x03,0xac,0x9c,
                        0x9e,0xb7,0x6f,0xac,0x45,0xaf,0x8e,0x51};
    uchar in2[32] = {    0x6b,0xc1,0xbe,0xe2,0x2e,0x40,0x9f,0x96,
                        0xe9,0x3d,0x7e,0x11,0x73,0x93,0x17,0x2a,
                        0xae,0x2d,0x8a,0x57,0x1e,0x03,0xac,0x9c,
                        0x9e,0xb7,0x6f,0xac,0x45,0xaf,0x8e,0x51};
    
    uchar expected_out[32] = {   0x60,0x1e,0xc3,0x13,0x77,0x57,0x89,0xa5,
                        0xb7,0xa7,0xf5,0x04,0xbb,0xf3,0xd2,0x28,
                        0xf4,0x43,0xe3,0xca,0x4d,0x62,0xb5,0x9a,
                        0xca,0x84,0xe9,0x90,0xca,0xca,0xf5,0xc5};
    uchar out[32];
    uchar out2[32];
    
    aes_encrypt(256, key, iv, in, out, 32, FALSE);
    
    // print_state((block*)out);
    print_arr("Encrypted", out, 32);
    
    printf("\n\n");
    
    uchar iv3[16];
    memcpy(iv3, out, 16);
    aes_encrypt(256, key, iv2, out, out2, 32, TRUE);
    
    print_state((block*)out2);
*/
